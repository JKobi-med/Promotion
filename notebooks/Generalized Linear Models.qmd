---
title: "Generalized Linear Models"
author: "Jonas J.R. Koberschinski"
date: "09-12-2024"
output: html
---

## Data import

```{r}
#Prep
 ## Set working directory
setwd("/Users/kobi/Desktop/Promotionsdatananalyse mit Excel und Martin/Rohdaten/")
print(getwd())

 ## Load necessary packages
library(haven)
library(tidyverse)
library(dplyr)
library(readxl)
library(writexl)
library(nlme)

 ## Load the BDNF data from a .sav file
 ### ??? more information !!!  restructured without methylation mean!
bdnf <- read_xlsx("BDNF_Neuroplastizität_Alter_CpGs_ohne_m11_und_p36_mit_verhalten_vollständig_umstrukturiert.xlsx")

tau <- suppressWarnings(read_xlsx("TAU_CpGs_mit_verhalten_ohne_p61_p59_p34_p29_umstruk.xlsx"))

psd95 <- suppressWarnings(read_xlsx("PSD95_CpGs_mit_verhalten_größer_umstrukturiert.xlsx"))

 ##first look at BDNF data
head(bdnf)
summary(bdnf)
 ## Check the structure of the dataset
str(bdnf)

```


## Drop NA
```{r}
# Remove rows with NA values in the 'methylierung' column
BDNF2 <- bdnf %>% drop_na(methylierung)

# Summarize the number of NA values in the 'methylierung' column (commented out)
# sum(is.na(BDNF$methylierung))

# without NA
summary(BDNF2)




tau2 <- tau %>% drop_na(methylation)


psd952  <- psd95  %>% drop_na(methylation)

```





## GLM (MHB-Code)
### BDNF
```{r}
# Load the nlme package for mixed models
library(nlme)

# Define mixed models without interaction
mixed_model_nointeraction1 <- lme(fixed= methylierung ~ as.factor(Group),
                                  random=~1|id_umstrukturieren,
                                  method="ML",data=BDNF2)
 
mixed_model_nointeraction2 <- lme(fixed= methylierung ~ as.factor(Group) +  as.factor(Zeitpunkt),
                                 random=~1|id_umstrukturieren,
                                 method="ML",data=BDNF2)

mixed_model_nointeraction_big_cpg <- lme(
  fixed = methylierung ~ as.factor(Group) + as.factor(Zeitpunkt) + as.factor(Standort) + as.factor(Geschlecht) + Age_start + CogTel,
  random = ~ 1 | id_umstrukturieren/CpG_position,
  method = "ML",
  data = BDNF2
)

mixed_model_nointeraction_big <- lme(
  fixed = methylierung ~ as.factor(Group) + as.factor(Zeitpunkt) + as.factor(Standort) + as.factor(Geschlecht) + Age_start + CogTel,
  random = ~ 1 | id_umstrukturieren,
  method = "ML",
  data = BDNF2
)

AIC(mixed_model_nointeraction1, mixed_model_nointeraction2, mixed_model_nointeraction_big)
BIC(mixed_model_nointeraction1, mixed_model_nointeraction2, mixed_model_nointeraction_big)

summary(mixed_model_nointeraction1)
summary(mixed_model_nointeraction2)
```

#### Best glm
```{r}

# Example dataset and model
# Ensure random effects variables are factors
BDNF2$CpG_position <- as.factor(BDNF2$CpG_position)
BDNF2$Zeitpunkt <- as.factor(BDNF2$Zeitpunkt)


bdnf_glm_1 <- lme(
  fixed = methylierung ~ as.factor(Group) + as.factor(Zeitpunkt) + as.factor(Geschlecht),
  random = ~ 1 | id_umstrukturieren/CpG_position,
  data = BDNF2,
  method = "ML"
)

# Fit alternative models
bdnf_glm_2 <- lme(
  fixed = methylierung ~ as.factor(Group) + as.factor(Zeitpunkt),
  random = ~ 1 | id_umstrukturieren,
  method = "ML",
  data = BDNF2
)

bdnf_glm_3 <- lme(
  fixed = methylierung ~ as.factor(Group) + as.factor(Zeitpunkt) + Age_start,
  random = ~ 1 | id_umstrukturieren/CpG_position,
  method = "ML",
  data = BDNF2
)

bdnf_glm_4 <- lme(
  fixed = methylierung ~ as.factor(Group) + as.factor(Zeitpunkt) + as.factor(Standort),
  random = ~ 1 | id_umstrukturieren/CpG_position/Zeitpunkt,
  method = "ML",
  data = BDNF2
)

# Compare models using AIC and BIC
AIC(bdnf_glm_1, bdnf_glm_2, bdnf_glm_3, bdnf_glm_4)
BIC(bdnf_glm_1, bdnf_glm_2, bdnf_glm_3, bdnf_glm_4)

```



```{r}
bdnf_glm_1 <- lme(
  fixed = methylierung ~ as.factor(Group) + as.factor(Zeitpunkt) + as.factor(Standort),
  random = ~ 1 | id_umstrukturieren,
  data = BDNF2,
  method = "ML"
)

bdnf_glm_2 <- lme(
  fixed = methylierung ~ as.factor(Group) + as.factor(Zeitpunkt),
  random = ~ 1 | id_umstrukturieren,
  method = "ML",
  data = BDNF2
)

glm_big<- lme(
    fixed = methylierung ~ as.factor(Group) + as.factor(Zeitpunkt) + 
    as.factor(Standort) + as.factor(Geschlecht) + Age_start + CogTel,
    random = ~ 1 | id_umstrukturieren/CpG_position,
    data = BDNF2,
    method = "ML"
  )

AIC(glm_big, bdnf_glm_1, bdnf_glm_2)
BIC(glm_big, bdnf_glm_1, bdnf_glm_2)

# bdnf_glm_2 preferred
summary(bdnf_glm_2)
```


#### better without random effect?

not clear

```{r}
bdnf_glm_2_fixed <- lm(
  methylierung ~ as.factor(Group) + as.factor(Zeitpunkt),
  data = BDNF2
)

# Compare AIC and BIC for both models
AIC(bdnf_glm_2, bdnf_glm_2_fixed)
BIC(bdnf_glm_2, bdnf_glm_2_fixed)

summary(bdnf_glm_2_fixed)

```




#### Model for group
```{r}
# Split the data by group
BDNF_controll = BDNF2[BDNF2$Gruppe=='Controll',]
BDNF_piano    = BDNF2[BDNF2$Gruppe=='Piano',]


# Define a mixed model for the Piano group?????
bdnf_mixed_model_piano <- lme(fixed= methylierung ~ as.factor(Zeitpunkt),
                                  random=~1|id_umstrukturieren,
                                  method="ML",data=BDNF_piano)

bdnf_mixed_model_controll <- lme(fixed= methylierung ~ as.factor(Zeitpunkt),
                                  random=~1|id_umstrukturieren,
                                  method="ML",data=BDNF_controll)


# Summarize the Piano group model
summary(bdnf_mixed_model_piano)
summary(bdnf_mixed_model_controll)

```


### Tau

```{r}
# Define mixed models without interaction
tau_mixed_model_nointeraction1 <- lme(fixed= methylation ~ as.factor(Gruppe),
                                  random=~1|id_umstruk,
                                  method="ML",data=tau2)
 
tau_mixed_model_nointeraction2 <- lme(fixed= methylation ~ as.factor(Gruppe) +  as.factor(Zeitpunkt),
                                 random=~1|id_umstruk,
                                 method="ML",data=tau2)


AIC(tau_mixed_model_nointeraction1, tau_mixed_model_nointeraction2)
BIC(tau_mixed_model_nointeraction1, tau_mixed_model_nointeraction2)

summary(tau_mixed_model_nointeraction1)
summary(tau_mixed_model_nointeraction2)

```


### PSD95 

```{r}
# Define mixed models without interaction
psd95_mixed_model_nointeraction1 <- lme(fixed= methylation ~ as.factor(Gruppe),
                                  random=~1|id_umstrukturiert,
                                  method="ML",data=psd952)
 
psd95_mixed_model_nointeraction2 <- lme(fixed= methylation ~ as.factor(Gruppe) +  as.factor(Zeitpunkt),
                                 random=~1|id_umstrukturiert,
                                 method="ML",data=psd952)

AIC(psd95_mixed_model_nointeraction1, psd95_mixed_model_nointeraction2)
BIC(psd95_mixed_model_nointeraction1, psd95_mixed_model_nointeraction2)

summary(psd95_mixed_model_nointeraction1)
summary(psd95_mixed_model_nointeraction2)
```

## BDNF-Interaction?


```{r}
# Summarize the no interaction models
summary(mixed_model_nointeraction1)
summary(mixed_model_nointeraction2)

# Plot the no interaction models
plot(mixed_model_nointeraction1)
# Corrected: changed 'mixed_model_nointeraction' to 'mixed_model_nointeraction2'
plot(mixed_model_nointeraction2)


# Perform post-hoc tests using glht
#contrasts <- glht(mixed_model_nointeraction2, linfct = mcp(Zeitpunkt = "Tukey"))
#summary(contrasts)


# Define a mixed model with interaction
mixed_model_interaction <- lme(fixed= methylierung~ as.factor(Group) 
                               +  as.factor(Zeitpunkt) 
                               +  as.factor(Zeitpunkt)*as.factor(Group), 
                               random=~1|id_umstrukturieren, 
                               method="ML", 
                               data=BDNF2)


# Summarize the interaction model
summary(mixed_model_interaction)
plot(mixed_model_interaction)

AIC(mixed_model_nointeraction1, mixed_model_nointeraction2, mixed_model_interaction)
BIC(mixed_model_nointeraction1, mixed_model_nointeraction2, mixed_model_interaction)

```




